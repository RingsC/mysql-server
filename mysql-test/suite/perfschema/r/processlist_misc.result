##
## Miscellaneous test cases for performance_schema.processlist
##
## Test cases:
##   1. Verify naming of foreground system threads.
##

##
## Test Case 1: Verify naming of foreground system threads.
##
## Foreground system threads should be named 'system user' except for
## singleton threads such as 'event_scheduler'.
##
## Reference: Bug#36895513 "Wrong result in P_S.processlist on replica node"
## NOTE: Results must be manually verified.
##

# Configure two servers to be source and replica.
include/rpl/init_source_replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]

# Wait until the replica SQL thread has been synced and all events have been copied over to the replica.
include/rpl/sync_to_replica.inc

# Stop replica.
include/rpl/stop_replica.inc

# Start replica.
include/rpl/start_replica.inc

# Verify processlist user name is 'system_user'.

select id, user,host,command,state from performance_schema.processlist order by user, id;
id	user	host	command	state
<ID>	event_scheduler	<Host>	Daemon	Waiting on empty queue
<ID>	root	<Host>	Sleep
<ID>	root	<Host>	Sleep
<ID>	root	<Host>	Query	executing
<ID>	root	<Host>	Sleep
<ID>	system user	<Host>	Connect	Waiting for source to send event
<ID>	system user	<Host>	Query	Replica has read all relay log; waiting for more updates
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator

# Create user 'test_processlist' then restart the replica and verify that
# the processlist user name for the replica threads is 'system user'.

CREATE USER 'test_processlist'@'localhost';
GRANT ALL ON *.* TO 'test_processlist'@'localhost';

# Stop replica.
include/rpl/stop_replica.inc

# Connect as 'test_processlist'.

# Start replica as user 'test_processlist'.
include/rpl/start_replica.inc

# Verify processlist user name is 'system_user' for the replica threads.

select id, user,host,command,state from performance_schema.processlist order by user, id;
id	user	host	command	state
<ID>	event_scheduler	<Host>	Daemon	Waiting on empty queue
<ID>	root	<Host>	Sleep
<ID>	root	<Host>	Sleep
<ID>	root	<Host>	Sleep
<ID>	root	<Host>	Sleep
<ID>	system user	<Host>	Connect	Waiting for source to send event
<ID>	system user	<Host>	Query	Replica has read all relay log; waiting for more updates
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	system user	<Host>	Connect	Waiting for an event from Coordinator
<ID>	test_processlist	<Host>	Query	executing

# Clean up.

DROP USER 'test_processlist'@'localhost';
include/rpl/deinit.inc
