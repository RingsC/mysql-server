# Save the initial number of concurrent sessions
--source include/count_sessions.inc

--source include/have_debug.inc
--source include/have_debug_sync.inc

SET DEBUG_SYNC= 'RESET';
--enable_connect_log
--connect (con1, localhost, root,,)

--echo ##############################################################
--echo # Bug#36846567 Inplace ALTER TABLE might cause lost rows if concurrent purge
--echo ##############################################################
--echo

--connection default
CREATE TABLE t1 (pk CHAR(5) PRIMARY KEY);
INSERT INTO t1 VALUES ('aaaaa'), ('bbbbb'), ('bbbcc'), ('ccccc'), ('ddddd'), ('eeeee');

SET GLOBAL INNODB_PURGE_STOP_NOW=ON;
DELETE FROM t1 WHERE pk = 'bbbcc';

--connection con1
SET DEBUG='+d,ddl_buf_add_two';
SET DEBUG_SYNC='ddl_bulk_inserter_latches_released SIGNAL latches_released WAIT_FOR go';
--echo # Send ALTER TABLE INPLACE which rebuilds table.
--send ALTER TABLE t1 ENGINE=InnoDB, ALGORITHM=INPLACE

--connection default
SET DEBUG_SYNC='now WAIT_FOR latches_released';
SET GLOBAL innodb_purge_run_now=ON;
--source include/wait_innodb_all_purged.inc
SET DEBUG_SYNC='now SIGNAL go';

--connection con1
--echo # Reap ALTER TABLE
--reap

--echo # Before the fix row 'ddddd' was missing from the table after ALTER.
SELECT * FROM t1;

SET DEBUG_SYNC= 'RESET';

--echo # Test cleanup
--connection default
SET DEBUG_SYNC= 'RESET';
DROP TABLE t1;

--echo ##############################################################
--echo # Test#2 Delete the first record
--echo ##############################################################
--echo

--connection default
CREATE TABLE t1 (pk CHAR(5) PRIMARY KEY);
INSERT INTO t1 VALUES ('aaaaa'), ('bbbbb'), ('bbbcc'), ('ccccc'), ('ddddd'), ('eeeee');


SET GLOBAL INNODB_PURGE_STOP_NOW=ON;
DELETE FROM t1 WHERE pk = 'aaaaa';

--connection con1
SET DEBUG='+d,ddl_buf_add_two';
SET DEBUG_SYNC='ddl_bulk_inserter_latches_released SIGNAL latches_released WAIT_FOR go';
--echo # Send ALTER TABLE INPLACE which rebuilds table.
--send ALTER TABLE t1 ENGINE=InnoDB, ALGORITHM=INPLACE

--connection default
SET DEBUG_SYNC='now WAIT_FOR latches_released';
SET GLOBAL innodb_purge_run_now=ON;
--source include/wait_innodb_all_purged.inc
SET DEBUG_SYNC='now SIGNAL go';

--connection con1
--echo # Reap ALTER TABLE
--reap

--echo # Verify intended records are present
SELECT * FROM t1;

SET DEBUG_SYNC= 'RESET';

--echo # Test cleanup
--connection default
SET DEBUG_SYNC= 'RESET';
DROP TABLE t1;

--echo ##############################################################
--echo # Test#3 Delete the second record
--echo ##############################################################
--echo

--connection default
CREATE TABLE t1 (pk CHAR(5) PRIMARY KEY);
INSERT INTO t1 VALUES ('aaaaa'), ('bbbbb'), ('bbbcc'), ('ccccc'), ('ddddd'), ('eeeee');

SET GLOBAL INNODB_PURGE_STOP_NOW=ON;
DELETE FROM t1 WHERE pk = 'bbbbb';

--connection con1
SET DEBUG='+d,ddl_buf_add_two';
SET DEBUG_SYNC='ddl_bulk_inserter_latches_released SIGNAL latches_released WAIT_FOR go';
--echo # Send ALTER TABLE INPLACE which rebuilds table.
--send ALTER TABLE t1 ENGINE=InnoDB, ALGORITHM=INPLACE

--connection default
SET DEBUG_SYNC='now WAIT_FOR latches_released';
SET GLOBAL innodb_purge_run_now=ON;
--source include/wait_innodb_all_purged.inc
SET DEBUG_SYNC='now SIGNAL go';

--connection con1
--echo # Reap ALTER TABLE
--reap

--echo # Verify intended records are present
SELECT * FROM t1;

SET DEBUG_SYNC= 'RESET';

--echo # Test cleanup
--connection default
SET DEBUG_SYNC= 'RESET';
DROP TABLE t1;

--echo ##############################################################
--echo # Test#4 Delete the fourth record
--echo ##############################################################
--echo

--connection default
CREATE TABLE t1 (pk CHAR(5) PRIMARY KEY);
INSERT INTO t1 VALUES ('aaaaa'), ('bbbbb'), ('bbbcc'), ('ccccc'), ('ddddd'), ('eeeee');

SET GLOBAL INNODB_PURGE_STOP_NOW=ON;
DELETE FROM t1 WHERE pk = 'ccccc';

--connection con1
SET DEBUG='+d,ddl_buf_add_two';
SET DEBUG_SYNC='ddl_bulk_inserter_latches_released SIGNAL latches_released WAIT_FOR go';
--echo # Send ALTER TABLE INPLACE which rebuilds table.
--send ALTER TABLE t1 ENGINE=InnoDB, ALGORITHM=INPLACE

--connection default
SET DEBUG_SYNC='now WAIT_FOR latches_released';
SET GLOBAL innodb_purge_run_now=ON;
--source include/wait_innodb_all_purged.inc
SET DEBUG_SYNC='now SIGNAL go';

--connection con1
--echo # Reap ALTER TABLE
--reap

--echo # Verify intended records are present
SELECT * FROM t1;

SET DEBUG_SYNC= 'RESET';

--echo # Test cleanup
--connection default
SET DEBUG_SYNC= 'RESET';
DROP TABLE t1;

--echo #
--echo # Cleanup.
DROP TABLE IF EXISTS t1;
--disconnect con1
--disable_connect_log
# Wait till all disconnects are completed
--source include/wait_until_count_sessions.inc
